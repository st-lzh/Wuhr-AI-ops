'use client'

import React, { useState, useEffect } from 'react'
import { Card, Table, Button, Space, Tag, message, Modal, Input, Typography, Row, Col, Statistic, Badge, Descriptions, Alert, Spin } from 'antd'
import { CheckOutlined, CloseOutlined, EyeOutlined, ReloadOutlined, ClockCircleOutlined, ProjectOutlined, UserOutlined } from '@ant-design/icons'
import MainLayout from '../../components/layout/MainLayout'
import { useAuth } from '../../hooks/useAuth'
import { usePermissions } from '../../hooks/usePermissions'
import { ApprovalWithRelations, ApprovalStats, getApprovalStatusDisplay } from '../../types/approval'

const { Title, Text, Paragraph } = Typography
const { TextArea } = Input

export default function ApprovalsPage() {
  const { user } = useAuth()
  const { hasPermission } = usePermissions()
  const [loading, setLoading] = useState(true)
  const [approvals, setApprovals] = useState<ApprovalWithRelations[]>([])
  const [userApprovals, setUserApprovals] = useState<any[]>([])
  const [stats, setStats] = useState<ApprovalStats | null>(null)
  const [currentPage, setCurrentPage] = useState(1)
  const [total, setTotal] = useState(0)
  const [activeTab, setActiveTab] = useState<'pending' | 'all' | 'my' | 'users'>('pending')
  const [detailModalVisible, setDetailModalVisible] = useState(false)
  const [selectedApproval, setSelectedApproval] = useState<ApprovalWithRelations | null>(null)
  const [actionModalVisible, setActionModalVisible] = useState(false)
  const [actionType, setActionType] = useState<'approve' | 'reject'>('approve')
  const [comment, setComment] = useState('')
  const [actionLoading, setActionLoading] = useState(false)

  // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
  const isAdmin = user?.role === 'admin'






  // ÊùÉÈôêÊ£ÄÊü•
  const canRead = hasPermission('cicd:read')
  const canWrite = hasPermission('cicd:write')

  // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
  const loadStats = async () => {
    try {
      console.log('üìä [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] ÂºÄÂßãÂä†ËΩΩÁªüËÆ°Êï∞ÊçÆ...')
      const response = await fetch('/api/cicd/approvals/stats')
      const data = await response.json()

      console.log('üìä [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] APIÂìçÂ∫î:', {
        success: data.success,
        dataKeys: data.data ? Object.keys(data.data) : [],
        pendingApprovals: data.data?.pendingApprovals,
        totalApprovals: data.data?.totalApprovals
      })

      if (data.success) {
        const statsData = {
          totalApprovals: data.data.totalApprovals || 0,
          pendingApprovals: data.data.pendingApprovals || 0,
          approvedToday: data.data.todayApproved || 0,
          rejectedToday: data.data.todayRejected || 0,
          myPendingApprovals: data.data.myPendingApprovals || 0,
          averageApprovalTime: data.data.averageApprovalTime || 0,
          // Êñ∞Â¢ûÁªüËÆ°Êï∞ÊçÆ
          todayTotal: data.data.todayTotal || 0,
          weeklyTotal: data.data.weeklyTotal || 0,
          monthlyTotal: data.data.monthlyTotal || 0,
          myTodayProcessed: data.data.myTodayProcessed || 0,
          myWeeklyProcessed: data.data.myWeeklyProcessed || 0,
          recentApprovals: data.data.recentApprovals || []
        }

        console.log('üìä [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] ËÆæÁΩÆÁªüËÆ°Êï∞ÊçÆ:', statsData)
        setStats(statsData)
      } else {
        console.error('üìä [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] APIËøîÂõûÂ§±Ë¥•:', data.error)
        message.error(data.error || 'Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•')
      }
    } catch (error) {
      console.error('üìä [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error)
      message.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•')
    }
  }

  // Âä†ËΩΩÂÆ°ÊâπÊï∞ÊçÆ
  const loadData = async () => {
    if (!canRead) return

    setLoading(true)
    try {
      // Âπ∂Ë°åÂä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂíåÂÆ°ÊâπÊï∞ÊçÆ
      await Promise.all([
        loadStats(),
        loadApprovals()
      ])
    } catch (error) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error)
      message.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•')
    } finally {
      setLoading(false)
    }
  }

  // Âä†ËΩΩÂÆ°ÊâπÂàóË°®
  const loadApprovals = async () => {
    try {
      if (activeTab === 'users') {
        // Áî®Êà∑ÂÆ°ÊâπËÆ∞ÂΩïÔºö‰ªéÂÆ°ÊâπËÆ∞ÂΩïAPIËé∑Âèñ
        const params = new URLSearchParams({
          approvalType: 'user_registration',
          page: currentPage.toString(),
          pageSize: '20'
        })

        const response = await fetch(`/api/approval-records?${params}`)
        if (response.ok) {
          const data = await response.json()
          setUserApprovals(data.data.records || [])
          setTotal(data.data.total || 0)
        } else {
          console.error('Ëé∑ÂèñÁî®Êà∑ÂÆ°ÊâπËÆ∞ÂΩïÂ§±Ë¥•')
          setUserApprovals([])
        }
        return
      }

      let params: URLSearchParams

      if (activeTab === 'pending') {
        // ÂæÖÂÆ°Êâπ‰ªªÂä°ÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑ÈúÄË¶ÅÂÆ°ÊâπÁöÑÂæÖÂ§ÑÁêÜ‰ªªÂä°
        params = new URLSearchParams({
          status: 'pending',
          page: currentPage.toString(),
          pageSize: '20',
          type: 'all'
        })
      } else if (activeTab === 'my') {
        // ÊàëÁöÑÂÆ°ÊâπÔºöÊòæÁ§∫ÂΩìÂâçÁî®Êà∑Â∑≤Â§ÑÁêÜÁöÑÂÆ°ÊâπËÆ∞ÂΩï
        params = new URLSearchParams({
          status: 'processed', // Êñ∞Â¢ûÁä∂ÊÄÅÔºöÂ∑≤Â§ÑÁêÜÔºàÂåÖÊã¨approvedÂíårejectedÔºâ
          page: currentPage.toString(),
          pageSize: '20',
          type: 'all'
        })
      } else {
        // ÂÖ®ÈÉ®ÂÆ°ÊâπÔºöÊòæÁ§∫ÊâÄÊúâÂÆ°ÊâπËÆ∞ÂΩïÔºà‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅÔºâ
        params = new URLSearchParams({
          status: 'all',
          page: currentPage.toString(),
          pageSize: '20',
          type: 'all'
        })
      }

      const response = await fetch(`/api/cicd/approvals?${params}`)
      const data = await response.json()

      if (data.success) {
        setApprovals(data.data.approvals || [])
        setTotal(data.data.pagination.total || 0)
        console.log(`‚úÖ ÂÆ°ÊâπÊï∞ÊçÆÂä†ËΩΩÊàêÂäü (${activeTab}):`, {
          count: data.data.approvals?.length || 0,
          total: data.data.pagination.total || 0
        })
      } else {
        console.error('‚ùå ÂÆ°ÊâπÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', data.error)
        message.error(data.error || 'Âä†ËΩΩÂÆ°ÊâπÊï∞ÊçÆÂ§±Ë¥•')
      }
    } catch (error) {
      console.error('‚ùå Âä†ËΩΩÂÆ°ÊâπÊï∞ÊçÆÂºÇÂ∏∏:', error)
      message.error('Âä†ËΩΩÂÆ°ÊâπÊï∞ÊçÆÂ§±Ë¥•')
    }
  }



  // Â§ÑÁêÜÂÆ°ÊâπÊìç‰Ωú
  const handleApprovalAction = async () => {
    if (!selectedApproval || !canWrite) return

    setActionLoading(true)
    try {
      const response = await fetch('/api/cicd/approvals', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          approvalId: selectedApproval.id,
          action: actionType,
          comments: comment.trim() || undefined,
          type: (selectedApproval as any).type || 'deployment'
        })
      })

      const data = await response.json()

      if (data.success) {
        message.success(`ÂÆ°Êâπ${actionType === 'approve' ? 'ÈÄöËøá' : 'ÊãíÁªù'}ÊàêÂäü`)
        setActionModalVisible(false)
        setComment('')
        setSelectedApproval(null)

        // Ëß¶ÂèëË∑®ÁªÑ‰ª∂Êï∞ÊçÆÂêåÊ≠•
        localStorage.setItem('notification_update', JSON.stringify({
          type: 'approval_action',
          action: actionType,
          approvalId: selectedApproval.id,
          timestamp: new Date().toISOString()
        }))
        window.dispatchEvent(new Event('approvalUpdate'))
        window.dispatchEvent(new Event('notificationUpdate'))

        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        loadData()

        // Ëß¶ÂèëÁªüËÆ°Êï∞ÊçÆÂà∑Êñ∞
        setTimeout(() => {
          loadData()
        }, 500) // Âª∂Ëøü500msÁ°Æ‰øùÊï∞ÊçÆÂ∫ìÊõ¥Êñ∞ÂÆåÊàê
      } else {
        message.error(data.error || 'ÂÆ°ÊâπÊìç‰ΩúÂ§±Ë¥•')
      }
    } catch (error: any) {
      console.error('‚ùå ÂÆ°ÊâπÊìç‰ΩúÂ§±Ë¥•:', error)
      message.error('ÂÆ°ÊâπÊìç‰ΩúÂ§±Ë¥•')
    } finally {
      setActionLoading(false)
    }
  }







  // Ëé∑ÂèñÁî®Êà∑ÂÆ°ÊâπËÆ∞ÂΩïË°®Ê†ºÂàóÈÖçÁΩÆ
  const getUserApprovalColumns = () => [
    {
      title: 'Áî®Êà∑‰ø°ÊÅØ',
      key: 'targetName',
      render: (record: any) => (
        <div>
          <div className="font-medium">{record.targetName}</div>
          <div className="text-sm text-gray-500">ID: {record.targetId}</div>
        </div>
      )
    },
    {
      title: 'ÂÆ°ÊâπÊìç‰Ωú',
      key: 'action',
      render: (record: any) => (
        <Tag color={record.action === 'approved' ? 'green' : 'red'}>
          {record.action === 'approved' ? 'ÈÄöËøá' : 'ÊãíÁªù'}
        </Tag>
      )
    },
    {
      title: 'ÂÆ°Êâπ‰∫∫',
      key: 'operator',
      render: (record: any) => (
        <div>
          <div className="font-medium">{record.operatorName}</div>
          <div className="text-sm text-gray-500">{record.operator?.email}</div>
        </div>
      )
    },
    {
      title: 'ÂÆ°ÊâπÊó∂Èó¥',
      key: 'operatedAt',
      render: (record: any) => (
        <div className="text-sm">
          {new Date(record.operatedAt).toLocaleString()}
        </div>
      )
    },
    {
      title: 'Â§áÊ≥®',
      key: 'comment',
      render: (record: any) => (
        <div className="text-sm text-gray-600">
          {record.comment || '-'}
        </div>
      )
    }
  ]

  // Âä®ÊÄÅË°®Ê†ºÂàóÂÆö‰πâ
  const getColumns = () => {
    const baseColumns = [
    {
      title: '‰ªªÂä°ÂêçÁß∞',
      key: 'deployment',
      render: (record: ApprovalWithRelations) => {
        if (record.type === 'user_registration') {
          return (
            <div>
              <div style={{ fontWeight: 500 }}>Áî®Êà∑Ê≥®ÂÜåÂÆ°Êâπ</div>
              <div style={{ color: '#666', fontSize: '12px' }}>
                <UserOutlined /> {record.registration?.username} ({record.registration?.email})
              </div>
            </div>
          )
        }
        return (
          <div>
            <div style={{ fontWeight: 500 }}>{record.deployment?.name || 'Êú™Áü•‰ªªÂä°'}</div>
            <div style={{ color: '#666', fontSize: '12px' }}>
              <ProjectOutlined /> {record.deployment?.project?.name || 'Êú™Áü•È°πÁõÆ'}
            </div>
          </div>
        )
      }
    },
    {
      title: 'ÁéØÂ¢É/Á±ªÂûã',
      key: 'environment',
      render: (record: ApprovalWithRelations) => {
        if (record.type === 'user_registration') {
          return <Tag color="purple">Áî®Êà∑Ê≥®ÂÜå</Tag>
        }
        const environment = record.deployment?.environment
        const colors = {
          prod: 'red',
          staging: 'orange',
          test: 'blue',
          dev: 'green'
        }
        return <Tag color={colors[environment as keyof typeof colors] || 'default'}>{environment || 'Êú™Áü•'}</Tag>
      }
    },
    {
      title: 'Áî≥ËØ∑‰∫∫',
      key: 'creator',
      render: (record: ApprovalWithRelations) => {
        if (record.type === 'user_registration') {
          return (
            <div>
              <UserOutlined /> {record.registration?.realName || record.registration?.username}
              <div style={{ color: '#666', fontSize: '12px' }}>
                {record.registration?.email}
              </div>
            </div>
          )
        }
        return (
          <div>
            <UserOutlined /> {record.deployment?.creator?.username || 'Êú™Áü•Áî®Êà∑'}
          </div>
        )
      }
    },
    {
      title: 'ÂÆ°Êâπ‰∫∫',
      key: 'approver',
      render: (record: ApprovalWithRelations) => {
        if (record.type === 'user_registration') {
          return (
            <div>
              <UserOutlined /> {record.approver?.username || 'ÂæÖÂàÜÈÖç'}
              <div style={{ color: '#666', fontSize: '12px' }}>
                ÁÆ°ÁêÜÂëò
              </div>
            </div>
          )
        }
        return (
          <div>
            <UserOutlined /> {record.approver?.username || 'Êú™Áü•'}
            <div style={{ color: '#666', fontSize: '12px' }}>
              {record.approver?.role || 'Êú™Áü•'}
            </div>
          </div>
        )
      }
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const statusInfo = getApprovalStatusDisplay(status as any)
        return <Tag color={statusInfo.color}>{statusInfo.label}</Tag>
      }
    },
    {
      title: 'Áî≥ËØ∑Êó∂Èó¥',
      dataIndex: 'createdAt',
      key: 'createdAt',
      render: (date: string) => new Date(date).toLocaleString()
    },
    {
      title: 'Êìç‰Ωú',
      key: 'actions',
      render: (record: ApprovalWithRelations) => (
        <Space>
          <Button
            type="link"
            icon={<EyeOutlined />}
            onClick={() => {
              setSelectedApproval(record)
              setDetailModalVisible(true)
            }}
          >
            ËØ¶ÊÉÖ
          </Button>
          {record.status === 'pending' && canWrite && (
            <>
              <Button
                type="primary"
                size="small"
                icon={<CheckOutlined />}
                style={{ backgroundColor: '#52c41a', borderColor: '#52c41a' }}
                onClick={() => {
                  setSelectedApproval(record)
                  setActionType('approve')
                  setActionModalVisible(true)
                }}
              >
                ÂêåÊÑè
              </Button>
              <Button
                type="primary"
                size="small"
                danger
                icon={<CloseOutlined />}
                onClick={() => {
                  setSelectedApproval(record)
                  setActionType('reject')
                  setActionModalVisible(true)
                }}
              >
                È©≥Âõû
              </Button>
            </>
          )}
        </Space>
      )
    }
    ]

    // Ê†πÊçÆÊ†áÁ≠æÈ°µËøîÂõû‰∏çÂêåÁöÑÂàóÈÖçÁΩÆ
    if (activeTab === 'my') {
      // ÊàëÁöÑÂÆ°ÊâπËÆ∞ÂΩïÔºöÊòæÁ§∫ÂÆ°ÊâπÁªìÊûúÂíåÂÆ°ÊâπÊó∂Èó¥Ôºå‰∏çÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
      return baseColumns.slice(0, -1).concat([
        {
          title: 'ÂÆ°ÊâπÁªìÊûú',
          key: 'result',
          render: (record: ApprovalWithRelations) => (
            <div>
              <Tag color={record.status === 'approved' ? 'green' : record.status === 'rejected' ? 'red' : 'orange'}>
                {record.status === 'approved' ? 'Â∑≤ÈÄöËøá' : record.status === 'rejected' ? 'Â∑≤ÊãíÁªù' : 'ÂæÖÂÆ°Êâπ'}
              </Tag>
              {record.comment && (
                <div style={{ color: '#666', fontSize: '12px', marginTop: '4px' }}>
                  Â§áÊ≥®Ôºö{record.comment}
                </div>
              )}
            </div>
          )
        },
        {
          title: 'ÂÆ°ÊâπÊó∂Èó¥',
          key: 'approvedAt',
          render: (record: ApprovalWithRelations) => (
            <span>{record.approvedAt ? new Date(record.approvedAt).toLocaleString() : '-'}</span>
          )
        },
        {
          title: 'Êìç‰Ωú',
          key: 'actions',
          render: (record: ApprovalWithRelations) => (
            <Button
              type="link"
              icon={<EyeOutlined />}
              onClick={() => {
                setSelectedApproval(record)
                setDetailModalVisible(true)
              }}
            >
              ËØ¶ÊÉÖ
            </Button>
          )
        }
      ])
    }

    // ÂæÖÂÆ°Êâπ‰ªªÂä°ÂíåÂÖ®ÈÉ®ÂÆ°ÊâπÔºöÊòæÁ§∫ÂÆåÊï¥ÁöÑÊìç‰ΩúÊåâÈíÆ
    return baseColumns
  }

  useEffect(() => {
    loadData()
  }, [activeTab, currentPage, canRead])

  // ÂÆûÊó∂ÂêåÊ≠•Êú∫Âà∂ - ÁõëÂê¨ÂÆ°ÊâπÁä∂ÊÄÅÊõ¥Êñ∞
  useEffect(() => {
    if (!user || !canRead) return

    // ÁõëÂê¨localStorageÂèòÂåñÔºåÂÆûÁé∞Ë∑®ÁªÑ‰ª∂Êï∞ÊçÆÂêåÊ≠•
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'notification_update' || e.key === 'deployment_status_update') {
        console.log('üîÑ [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] Êî∂Âà∞Êï∞ÊçÆÊõ¥Êñ∞ÔºåÂà∑Êñ∞ÂÆ°ÊâπÂàóË°®')
        loadData()
        // Ê∏ÖÈô§ÈÄöÁü•Ê†áËÆ∞
        localStorage.removeItem('notification_update')
        localStorage.removeItem('deployment_status_update')
      }
    }

    // ÁõëÂê¨Ëá™ÂÆö‰πâ‰∫ã‰ª∂ÔºåÂÆûÁé∞ÂêåÈ°µÈù¢ÁªÑ‰ª∂Èó¥ÂêåÊ≠•
    const handleApprovalUpdate = () => {
      console.log('üîÑ [ÂÆ°ÊâπÁÆ°ÁêÜÈ°µÈù¢] Êî∂Âà∞ÂÆ°ÊâπÊõ¥Êñ∞‰∫ã‰ª∂ÔºåÂà∑Êñ∞Êï∞ÊçÆ')
      loadData()
    }

    window.addEventListener('storage', handleStorageChange)
    window.addEventListener('approvalUpdate', handleApprovalUpdate)

    // ÂÆöÊúüÂà∑Êñ∞Êï∞ÊçÆÔºàÊØè30ÁßíÔºâ
    const refreshInterval = setInterval(() => {
      loadData()
    }, 30000)

    return () => {
      window.removeEventListener('storage', handleStorageChange)
      window.removeEventListener('approvalUpdate', handleApprovalUpdate)
      clearInterval(refreshInterval)
    }
  }, [user, canRead, activeTab, currentPage])

  if (!canRead) {
    return (
      <MainLayout>
        <div className="p-6">
          <Alert
            message="ËÆøÈóÆÂèóÈôê"
            description="ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÂÆ°ÊâπÁÆ°ÁêÜÂäüËÉΩ„ÄÇ"
            type="warning"
            showIcon
          />
        </div>
      </MainLayout>
    )
  }

  return (
    <MainLayout>
      <div className="p-6">
        <div className="mb-6">
          <Title level={2} className="mb-2">
            <ClockCircleOutlined className="mr-2" />
            ÂÆ°ÊâπÁÆ°ÁêÜ
          </Title>
          <Paragraph className="text-gray-600 mb-0">
            ÁÆ°ÁêÜÈÉ®ÁΩ≤ÂÆ°ÊâπÊµÅÁ®ãÔºåÊü•ÁúãÂæÖÂÆ°Êâπ‰ªªÂä°ÂíåÂÆ°ÊâπÂéÜÂè≤
          </Paragraph>
        </div>

      {/* ÁªüËÆ°Âç°Áâá */}
      <Row gutter={16} style={{ marginBottom: '20px' }}>
        <Col span={6}>
          <Card className="glass-card">
            <Statistic
              title="ÂæÖÂÆ°Êâπ‰ªªÂä°"
              value={stats?.pendingApprovals || 0}
              prefix={<ClockCircleOutlined style={{ color: '#faad14' }} />}
              valueStyle={{ color: '#faad14' }}
              loading={!stats}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card className="glass-card">
            <Statistic
              title="ÊàëÁöÑÂæÖÂÆ°Êâπ"
              value={stats?.myPendingApprovals || 0}
              prefix={<Badge count={stats?.myPendingApprovals || 0} />}
              valueStyle={{ color: '#1890ff' }}
              loading={!stats}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card className="glass-card">
            <Statistic
              title="‰ªäÊó•Â∑≤Â§ÑÁêÜ"
              value={stats?.todayTotal || ((stats?.approvedToday || 0) + (stats?.rejectedToday || 0))}
              suffix={`(ÈÄöËøá${stats?.approvedToday || 0}/ÊãíÁªù${stats?.rejectedToday || 0})`}
              valueStyle={{ color: '#52c41a' }}
              loading={!stats}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card className="glass-card">
            <Statistic
              title="Âπ≥ÂùáÂÆ°ÊâπÊó∂Èó¥"
              value={stats?.averageApprovalTime || 0}
              suffix="Â∞èÊó∂"
              precision={1}
              valueStyle={{ color: '#722ed1' }}
              loading={!stats}
            />
          </Card>
        </Col>
      </Row>

      {/* ËØ¶ÁªÜÁªüËÆ° */}
      <Row gutter={16} style={{ marginBottom: '20px' }}>
        <Col span={8}>
          <Card className="glass-card" title="ÊàëÁöÑÂ§ÑÁêÜÁªüËÆ°">
            <Row gutter={16}>
              <Col span={12}>
                <Statistic
                  title="‰ªäÊó•Â§ÑÁêÜ"
                  value={stats?.myTodayProcessed || 0}
                  valueStyle={{ color: '#1890ff' }}
                  loading={!stats}
                />
              </Col>
              <Col span={12}>
                <Statistic
                  title="Êú¨Âë®Â§ÑÁêÜ"
                  value={stats?.myWeeklyProcessed || 0}
                  valueStyle={{ color: '#52c41a' }}
                  loading={!stats}
                />
              </Col>
            </Row>
          </Card>
        </Col>
        <Col span={8}>
          <Card className="glass-card" title="Á≥ªÁªüÂ§ÑÁêÜÁªüËÆ°">
            <Row gutter={16}>
              <Col span={12}>
                <Statistic
                  title="Êú¨Âë®Â§ÑÁêÜ"
                  value={stats?.weeklyTotal || 0}
                  valueStyle={{ color: '#722ed1' }}
                  loading={!stats}
                />
              </Col>
              <Col span={12}>
                <Statistic
                  title="Êú¨ÊúàÂ§ÑÁêÜ"
                  value={stats?.monthlyTotal || 0}
                  valueStyle={{ color: '#fa8c16' }}
                  loading={!stats}
                />
              </Col>
            </Row>
          </Card>
        </Col>
        <Col span={8}>
          <Card className="glass-card" title="‰ªäÊó•Ê¥ªÂä®">
            {!stats ? (
              <Spin size="small" />
            ) : stats.recentApprovals && stats.recentApprovals.length > 0 ? (
              <div className="space-y-2 max-h-20 overflow-y-auto">
                {stats.recentApprovals.slice(0, 3).map((approval, index) => (
                  <div key={index} className="text-sm">
                    <Tag
                      color={approval.status === 'approved' ? 'green' : 'red'}
                    >
                      {approval.status === 'approved' ? 'ÈÄöËøá' : 'ÊãíÁªù'}
                    </Tag>
                    <span className="text-gray-600">
                      {approval.projectName} - {approval.deploymentName}
                    </span>
                  </div>
                ))}
              </div>
            ) : (
              <Text type="secondary">‰ªäÊó•ÊöÇÊó†ÂÆ°ÊâπÊ¥ªÂä®</Text>
            )}
          </Card>
        </Col>
      </Row>

      {/* Ê†áÁ≠æÈ°µ */}
      <Card className="glass-card" style={{ marginBottom: '20px' }}>
        <div style={{ marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <Space>
            <Button
              type={activeTab === 'pending' ? 'primary' : 'default'}
              onClick={() => {
                setActiveTab('pending')
                setCurrentPage(1)
              }}
            >
              ÂæÖÂÆ°Êâπ‰ªªÂä°
            </Button>
            <Button
              type={activeTab === 'my' ? 'primary' : 'default'}
              onClick={() => {
                setActiveTab('my')
                setCurrentPage(1)
              }}
            >
              ÊàëÁöÑÂÆ°ÊâπËÆ∞ÂΩï
            </Button>
            {/* Âè™ÊúâÁÆ°ÁêÜÂëòÊâçËÉΩÁúãÂà∞ÂÖ®ÈÉ®ÂÆ°Êâπ */}
            {isAdmin && (
              <Button
                type={activeTab === 'all' ? 'primary' : 'default'}
                onClick={() => {
                  setActiveTab('all')
                  setCurrentPage(1)
                }}
              >
                ÂÖ®ÈÉ®ÂÆ°Êâπ
              </Button>
            )}
            {/* Áî®Êà∑ÂÆ°ÊâπËÆ∞ÂΩï */}
            <Button
              type={activeTab === 'users' ? 'primary' : 'default'}
              onClick={() => {
                setActiveTab('users')
                setCurrentPage(1)
              }}
            >
              Áî®Êà∑ÂÆ°Êâπ
            </Button>

          </Space>
          <Button 
            icon={<ReloadOutlined />} 
            onClick={loadData}
            loading={loading}
          >
            Âà∑Êñ∞
          </Button>
        </div>

        {/* Ê†áÁ≠æÈ°µËØ¥Êòé */}
        <div style={{ marginBottom: '16px' }}>
          {activeTab === 'pending' && (
            <Alert
              message="ÂæÖÂÆ°Êâπ‰ªªÂä°"
              description="ÊòæÁ§∫ÈúÄË¶ÅÊÇ®ÂÆ°ÊâπÁöÑÂæÖÂ§ÑÁêÜ‰ªªÂä°ÔºåÂåÖÊã¨ÈÉ®ÁΩ≤ÂÆ°ÊâπÂíåJenkins‰ªªÂä°ÂÆ°Êâπ„ÄÇ"
              type="info"
              showIcon
              style={{ marginBottom: '16px' }}
            />
          )}
          {activeTab === 'my' && (
            <Alert
              message="ÊàëÁöÑÂÆ°ÊâπËÆ∞ÂΩï"
              description="ÊòæÁ§∫ÊÇ®Â∑≤ÁªèÂ§ÑÁêÜËøáÁöÑÂÆ°ÊâπËÆ∞ÂΩïÔºåÂåÖÊã¨Â∑≤ÈÄöËøáÂíåÂ∑≤ÊãíÁªùÁöÑÂÆ°Êâπ„ÄÇ"
              type="info"
              showIcon
              style={{ marginBottom: '16px' }}
            />
          )}
          {activeTab === 'all' && isAdmin && (
            <Alert
              message="ÂÖ®ÈÉ®ÂÆ°Êâπ"
              description="ÊòæÁ§∫Á≥ªÁªü‰∏≠ÊâÄÊúâÁöÑÂÆ°ÊâπËÆ∞ÂΩïÔºåÂåÖÊã¨ÂæÖÂ§ÑÁêÜÂíåÂ∑≤Â§ÑÁêÜÁöÑÂÆ°ÊâπÔºà‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅÔºâ„ÄÇ"
              type="info"
              showIcon
              style={{ marginBottom: '16px' }}
            />
          )}
        </div>

        {/* Ê†πÊçÆÊ†áÁ≠æÈ°µÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ */}
        {activeTab === 'users' ? (
          <Table
            columns={getUserApprovalColumns()}
            dataSource={userApprovals}
            rowKey="id"
            loading={loading}
            pagination={{
              current: currentPage,
              total,
              pageSize: 20,
              onChange: setCurrentPage,
              showSizeChanger: false,
              showQuickJumper: true,
              showTotal: (total, range) => `${range[0]}-${range[1]} / ${total} Êù°`
            }}
          />
        ) : (
          <Table
            columns={getColumns()}
            dataSource={approvals}
            rowKey="id"
            loading={loading}
            pagination={activeTab !== 'pending' ? {
              current: currentPage,
              total,
              pageSize: 10,
              onChange: setCurrentPage,
              showSizeChanger: false,
              showQuickJumper: true,
              showTotal: (total, range) => `${range[0]}-${range[1]} / ${total} Êù°`
            } : false}
          />
        )}







      </Card>

      {/* ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title="ÂÆ°ÊâπËØ¶ÊÉÖ"
        open={detailModalVisible}
        onCancel={() => {
          setDetailModalVisible(false)
          setSelectedApproval(null)
        }}
        footer={null}
        width={800}
      >
        {selectedApproval && (
          <Descriptions column={2} bordered>
            {selectedApproval.type === 'user_registration' ? (
              <>
                <Descriptions.Item label="ÂÆ°ÊâπÁ±ªÂûã" span={2}>
                  Áî®Êà∑Ê≥®ÂÜåÂÆ°Êâπ
                </Descriptions.Item>
                <Descriptions.Item label="Áî®Êà∑Âêç">
                  {selectedApproval.registration?.username}
                </Descriptions.Item>
                <Descriptions.Item label="ÈÇÆÁÆ±">
                  {selectedApproval.registration?.email}
                </Descriptions.Item>
                <Descriptions.Item label="ÁúüÂÆûÂßìÂêç">
                  {selectedApproval.registration?.realName || '-'}
                </Descriptions.Item>
                <Descriptions.Item label="Áî≥ËØ∑ÂéüÂõ†" span={2}>
                  {selectedApproval.registration?.reason || '-'}
                </Descriptions.Item>
              </>
            ) : (
              <>
                <Descriptions.Item label="ÈÉ®ÁΩ≤‰ªªÂä°" span={2}>
                  {selectedApproval.deployment?.name || 'Êú™Áü•‰ªªÂä°'}
                </Descriptions.Item>
                <Descriptions.Item label="È°πÁõÆ">
                  {selectedApproval.deployment?.project?.name || 'Êú™Áü•È°πÁõÆ'}
                </Descriptions.Item>
                <Descriptions.Item label="ÁéØÂ¢É">
                  <Tag color={
                    selectedApproval.deployment?.environment === 'prod' ? 'red' :
                    selectedApproval.deployment?.environment === 'staging' ? 'orange' :
                    selectedApproval.deployment?.environment === 'test' ? 'blue' : 'green'
                  }>
                    {selectedApproval.deployment?.environment || 'Êú™Áü•'}
                  </Tag>
                </Descriptions.Item>
                <Descriptions.Item label="Áî≥ËØ∑‰∫∫">
                  {selectedApproval.deployment?.creator?.username || 'Êú™Áü•Áî®Êà∑'}
                </Descriptions.Item>
                <Descriptions.Item label="ÈÉ®ÁΩ≤ÊèèËø∞" span={2}>
                  {selectedApproval.deployment?.description || '-'}
                </Descriptions.Item>
              </>
            )}
            <Descriptions.Item label="ÂÆ°Êâπ‰∫∫">
              {selectedApproval.approver?.username || 'ÂæÖÂàÜÈÖç'} ({selectedApproval.approver?.role || 'Êú™Áü•'})
            </Descriptions.Item>
            <Descriptions.Item label="Áä∂ÊÄÅ">
              {(() => {
                const statusInfo = getApprovalStatusDisplay(selectedApproval.status)
                return <Tag color={statusInfo.color}>{statusInfo.label}</Tag>
              })()}
            </Descriptions.Item>
            <Descriptions.Item label="Áî≥ËØ∑Êó∂Èó¥">
              {new Date(selectedApproval.createdAt).toLocaleString()}
            </Descriptions.Item>
            <Descriptions.Item label="Â§ÑÁêÜÊó∂Èó¥">
              {selectedApproval.approvedAt ? new Date(selectedApproval.approvedAt).toLocaleString() : '-'}
            </Descriptions.Item>
            <Descriptions.Item label="ÂÆ°ÊâπÊÑèËßÅ" span={2}>
              {selectedApproval.comment || '-'}
            </Descriptions.Item>
          </Descriptions>
        )}
      </Modal>

      {/* ÂÆ°ÊâπÊìç‰ΩúÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={actionType === 'approve' ? 'ÊâπÂáÜÂÆ°Êâπ' : 'ÊãíÁªùÂÆ°Êâπ'}
        open={actionModalVisible}
        onOk={handleApprovalAction}
        onCancel={() => {
          setActionModalVisible(false)
          setComment('')
          setSelectedApproval(null)
        }}
        confirmLoading={actionLoading}
        okText={actionType === 'approve' ? 'ÊâπÂáÜ' : 'ÊãíÁªù'}
        okButtonProps={{ 
          danger: actionType === 'reject',
          style: actionType === 'approve' ? { backgroundColor: '#52c41a', borderColor: '#52c41a' } : undefined
        }}
      >
        {selectedApproval && (
          <div>
            <Paragraph>
              ÊÇ®Á°ÆÂÆöË¶Å<Text strong>{actionType === 'approve' ? 'ÊâπÂáÜ' : 'ÊãíÁªù'}</Text>‰ª•‰∏ãÂÆ°ÊâπÂêóÔºü
            </Paragraph>
            <Card size="small" style={{ marginBottom: '16px' }}>
              {selectedApproval.type === 'user_registration' ? (
                <>
                  <Text strong>ÂÆ°ÊâπÁ±ªÂûãÔºö</Text>Áî®Êà∑Ê≥®ÂÜåÂÆ°Êâπ<br />
                  <Text strong>Áî®Êà∑ÂêçÔºö</Text>{selectedApproval.registration?.username}<br />
                  <Text strong>ÈÇÆÁÆ±Ôºö</Text>{selectedApproval.registration?.email}<br />
                  <Text strong>ÁúüÂÆûÂßìÂêçÔºö</Text>{selectedApproval.registration?.realName || '-'}
                </>
              ) : (
                <>
                  <Text strong>ÈÉ®ÁΩ≤‰ªªÂä°Ôºö</Text>{selectedApproval.deployment?.name || 'Êú™Áü•‰ªªÂä°'}<br />
                  <Text strong>È°πÁõÆÔºö</Text>{selectedApproval.deployment?.project?.name || 'Êú™Áü•È°πÁõÆ'}<br />
                  <Text strong>ÁéØÂ¢ÉÔºö</Text>{selectedApproval.deployment?.environment || 'Êú™Áü•'}<br />
                  <Text strong>Áî≥ËØ∑‰∫∫Ôºö</Text>{selectedApproval.deployment?.creator?.username || 'Êú™Áü•Áî®Êà∑'}
                </>
              )}
            </Card>
            <div>
              <Text strong>ÂÆ°ÊâπÊÑèËßÅÔºö</Text>
              <TextArea
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                placeholder={`ËØ∑ËæìÂÖ•${actionType === 'approve' ? 'ÊâπÂáÜ' : 'ÊãíÁªù'}ÂéüÂõ†ÔºàÂèØÈÄâÔºâ`}
                rows={3}
                style={{ marginTop: '8px' }}
              />
            </div>
          </div>
        )}
      </Modal>
      </div>
    </MainLayout>
  )
}
